name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell Core
        shell: pwsh
        run: |
          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Install 7-Zip
        run: |
          choco install 7zip -y
          $env:Path += ";C:\Program Files\7-Zip"
          echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build mod package
        shell: pwsh
        run: |
          .\bundle-copy.ps1 -createPublicRelease

      - name: Get short SHA
        id: slug
        shell: pwsh
        run: |
          $shortSha = "${{ github.sha }}".Substring(0, 7)
          echo "sha=$shortSha" >> $env:GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ steps.slug.outputs.sha }}
          release_name: Ultrawide Mod Release ${{ steps.slug.outputs.sha }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./ultra_widescreen.zip
          asset_name: ultra_widescreen.zip
          asset_content_type: application/zip
